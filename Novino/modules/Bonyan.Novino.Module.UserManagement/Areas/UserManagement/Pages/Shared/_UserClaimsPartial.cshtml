@using Bonyan.IdentityManagement.Permissions
@model UserDetailsViewModel

<div class="row">
    <div class="col-12">
        <!-- User Claims Card -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="ri-file-list-line me-2"></i>مجوزهای کاربر
                </h5>
                <div class="d-flex gap-2">
                    @if (Model.CanManageClaims)
                    {
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#manageClaimsModal">
                            <i class="ri-add-line align-bottom me-1"></i>افزودن مجوز
                        </button>
                    }
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="refreshClaims()">
                        <i class="ri-refresh-line align-bottom me-1"></i>بازنشانی
                    </button>
                </div>
            </div>
            <div class="card-body">
                @if (!Model.Claims.Any())
                {
                    <div class="text-center py-4">
                        <div class="avatar-lg mx-auto mb-3">
                            <div class="avatar-title bg-light rounded-circle">
                                <i class="ri-file-list-line text-muted fs-24"></i>
                            </div>
                        </div>
                        <h5 class="text-muted">هیچ مجوز تعیین نشده</h5>
                        <p class="text-muted mb-3">این کاربر هنوز هیچ مجوز ندارد.</p>
                        @if (Model.CanManageClaims)
                        {
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#manageClaimsModal">
                                <i class="ri-add-line align-bottom me-1"></i>افزودن مجوز اول
                            </button>
                        }
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>نوع مجوز</th>
                                    <th>مقدار</th>
                                    <th>Issuer</th>
                                    <th>وضعیت</th>
                                    <th>عملیات</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var claim in Model.Claims)
                                {
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-sm bg-info-subtle rounded me-2">
                                                    <div class="avatar-title">
                                                        <i class="ri-file-list-line text-info"></i>
                                                    </div>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0">@claim.ClaimType</h6>
                                                    <small class="text-muted">@GetClaimTypeDescription(claim.ClaimType)</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <span class="text-body">@claim.ClaimValue</span>
                                                @if (IsSpecialClaim(claim.ClaimType))
                                                {
                                                    <span class="badge bg-warning-subtle text-warning ms-2">
                                                        <i class="ri-star-line"></i>
                                                    </span>
                                                }
                                            </div>
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(claim.Issuer))
                                            {
                                                <span class="text-body">@claim.Issuer</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">سیستم</span>
                                            }
                                        </td>
                                        <td>
                                            @if (IsSpecialClaim(claim.ClaimType))
                                            {
                                                <span class="badge bg-warning-subtle text-warning">
                                                    <i class="ri-star-line me-1"></i>ویژه
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-success-subtle text-success">
                                                    <i class="ri-check-line me-1"></i>عادی
                                                </span>
                                            }
                                        </td>
                                        <td>
                                            <div class="d-flex gap-1">
                                                @if (CanDeleteClaim(claim.ClaimType) && Model.CanManageClaims)
                                                {
                                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                                            onclick="removeClaim('@Model.Id', '@claim.ClaimType', '@claim.ClaimValue')" 
                                                            title="حذف مجوز">
                                                        <i class="ri-delete-bin-line"></i>
                                                    </button>
                                                }
                                                else if (!CanDeleteClaim(claim.ClaimType))
                                                {
                                                    <span class="badge bg-warning-subtle text-warning">
                                                        <i class="ri-lock-line me-1"></i>سیستمی
                                                    </span>
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>

        <!-- Claims Statistics -->
        <div class="row mt-3">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="avatar-sm bg-primary-subtle rounded">
                                <div class="avatar-title">
                                    <i class="ri-file-list-line text-primary"></i>
                                </div>
                            </div>
                            <div class="ms-3">
                                <h6 class="mb-0">تعداد مجوزها</h6>
                                <p class="text-muted mb-0">@Model.Claims.Count</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="avatar-sm bg-success-subtle rounded">
                                <div class="avatar-title">
                                    <i class="ri-checkbox-circle-line text-success"></i>
                                </div>
                            </div>
                            <div class="ms-3">
                                <h6 class="mb-0">مجوزهای عادی</h6>
                                <p class="text-muted mb-0">@Model.Claims.Count(c => !IsSpecialClaim(c.ClaimType))</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="avatar-sm bg-warning-subtle rounded">
                                <div class="avatar-title">
                                    <i class="ri-star-line text-warning"></i>
                                </div>
                            </div>
                            <div class="ms-3">
                                <h6 class="mb-0">مجوزهای ویژه</h6>
                                <p class="text-muted mb-0">@Model.Claims.Count(c => IsSpecialClaim(c.ClaimType))</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@if (Model.CanManageClaims)
{
    <!-- Manage Claims Modal -->
    <div class="modal fade" id="manageClaimsModal" tabindex="-1" aria-labelledby="manageClaimsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageClaimsModalLabel">
                        <i class="ri-file-list-line me-2"></i>افزودن مجوز جدید
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" asp-page-handler="ManageClaims" id="manageClaimsForm">
                    <div class="modal-body">
                        <input type="hidden" name="UserId" value="@Model.Id" />
                        
                        <div class="alert alert-info">
                            <i class="ri-information-line me-2"></i>
                            مجوز جدید برای کاربر <strong>@Model.FullName</strong> اضافه خواهد شد.
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">نوع مجوز</label>
                            <select class="form-select" name="ClaimType" id="claimType" required>
                                <option value="">انتخاب کنید...</option>
                                <option value="@BonPermissionClaimTypes.Permission">دسترسی</option>
                                <option value="@BonPermissionClaimTypes.Feature">ویژگی</option>
                                <option value="@BonPermissionClaimTypes.ModuleAccess">مجوز به ماژول</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">مقدار Claim</label>
                            <input type="text" class="form-control" name="ClaimValue" id="claimValue" 
                                   placeholder="مقدار Claim را وارد کنید" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Issuer (اختیاری)</label>
                            <input type="text" class="form-control" name="Issuer" id="issuer" 
                                   placeholder="Issuer را وارد کنید">
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="ForceChangePassword" id="forceChangePasswordClaim">
                                <label class="form-check-label" for="forceChangePasswordClaim">
                                    اجبار تغییر رمز عبور در ورود بعدی
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">انصراف</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="ri-save-line align-bottom me-1"></i>افزودن مجوز
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle claim type change
        const claimTypeSelect = document.getElementById('claimType');
        const claimValueInput = document.getElementById('claimValue');
        const forceChangePasswordCheckbox = document.getElementById('forceChangePasswordClaim');
        
        if (claimTypeSelect && claimValueInput) {
            claimTypeSelect.addEventListener('change', function() {
                const selectedType = this.value;
                
                // Auto-fill claim value for special types
                if (selectedType === 'ForceChangePassword') {
                    claimValueInput.value = 'true';
                    claimValueInput.readOnly = true;
                    forceChangePasswordCheckbox.checked = true;
                } else {
                    claimValueInput.value = '';
                    claimValueInput.readOnly = false;
                    forceChangePasswordCheckbox.checked = false;
                }
            });
        }
        
        // Handle force change password checkbox
        if (forceChangePasswordCheckbox) {
            forceChangePasswordCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    claimTypeSelect.value = 'ForceChangePassword';
                    claimValueInput.value = 'true';
                    claimValueInput.readOnly = true;
                } else {
                    claimValueInput.readOnly = false;
                }
            });
        }
    });
    
    function refreshClaims() {
        // Reload the claims tab content
        const claimsTab = document.getElementById('user-claims');
        if (claimsTab) {
            location.reload();
        }
    }
    
    function removeClaim(userId, claimType, claimValue) {
        if (confirm(`آیا از حذف Claim "${claimType}: ${claimValue}" از کاربر اطمینان دارید؟`)) {
            // Show loading state
            const button = event.target.closest('button');
            const originalContent = button.innerHTML;
            button.innerHTML = '<i class="ri-loader-4-line"></i>';
            button.disabled = true;
            
            // Send remove request
            fetch('/UserManagement/User/RemoveClaim', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify({
                    userId: userId,
                    claimType: claimType,
                    claimValue: claimValue
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload the page to show updated claims
                    window.location.reload();
                } else {
                    alert('خطا در حذف Claim: ' + data.message);
                    // Restore button state
                    button.innerHTML = originalContent;
                    button.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('خطا در حذف Claim');
                // Restore button state
                button.innerHTML = originalContent;
                button.disabled = false;
            });
        }
    }
</script>

@functions {
    private string GetClaimTypeDescription(string claimType)
    {
        return claimType switch
        {
            "Permission" => "مجوز",
            "Department" => "دپارتمان",
            "Location" => "موقعیت",
            "ForceChangePassword" => "اجبار تغییر رمز",
            "Custom" => "سفارشی",
            _ => "سایر"
        };
    }
    
    private bool IsSpecialClaim(string claimType)
    {
        return claimType switch
        {
            "ForceChangePassword" => true,
            "Permission" => true,
            _ => false
        };
    }
    
    private bool CanDeleteClaim(string claimType)
    {
        // System claims that shouldn't be deleted
        return claimType switch
        {
            "ForceChangePassword" => false,
            _ => true
        };
    }
} 