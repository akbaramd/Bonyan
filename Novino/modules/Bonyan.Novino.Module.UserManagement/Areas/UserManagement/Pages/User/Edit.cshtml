@page "{id:guid}"
@model Bonyan.Novino.Module.UserManagement.Areas.UserManagement.Pages.User.EditModel
@{
    ViewData["Title"] = $"ویرایش کاربر - {Model.User.UserName}";
}

<div class="row">
    <div class="col-12">
        <div class="page-title-box d-flex flex-column flex-sm-row gap-2
            align-items-start align-items-sm-center justify-content-sm-between">
            <h4 class="mb-sm-0">
                <span>ویرایش کاربر</span>
            </h4>

            <div class="page-title-right">
                <ol class="breadcrumb m-0">
                    <li class="breadcrumb-item">
                        <a href="@Url.Page("/Index", new { area = "" })">داشبورد</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a asp-page="Index">مدیریت کاربران</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a asp-page="Detail" asp-route-id="@Model.User.Id">جزئیات کاربر</a>
                    </li>
                    <li class="breadcrumb-item active">ویرایش کاربر</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-12">
        @if (Model.ErrorMessage != null)
        {
            <div class="alert alert-danger alert-dismissible alert-solid alert-label-icon fade show" role="alert">
                <i class="ri-error-warning-line label-icon"></i><strong>خطا</strong> @Model.ErrorMessage
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <!-- User Information Card -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="avatar-sm">
                            <div class="avatar-title bg-primary-subtle text-primary rounded-circle fs-20">
                                <i class="ri-user-settings-line"></i>
                            </div>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h5 class="card-title mb-1">ویرایش اطلاعات کاربر</h5>
                        <p class="card-text text-muted mb-0">اطلاعات کاربری را ویرایش کرده و تغییرات را ذخیره کنید.</p>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <form method="post" id="editForm">
                    <div class="row">
                        <!-- Basic Information -->
                        <div class="col-lg-6">
                            <div class="card border">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">
                                        <i class="ri-user-line text-primary me-2"></i>
                                        اطلاعات پایه
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label asp-for="User.UserName" class="form-label">
                                            <i class="ri-user-line me-1"></i>
                                            نام کاربری
                                        </label>
                                        <input type="text" 
                                               class="form-control @(ViewData.ModelState["User.UserName"]?.Errors.Any() == true ? "is-invalid" : "")" 
                                               asp-for="User.UserName" 
                                               placeholder="نام کاربری را وارد کنید">
                                        <span asp-validation-for="User.UserName" class="invalid-feedback"></span>
                                    </div>

                                    <div class="mb-3">
                                        <label asp-for="User.Name" class="form-label">
                                            <i class="ri-user-settings-line me-1"></i>
                                            نام
                                        </label>
                                        <input type="text" 
                                               class="form-control @(ViewData.ModelState["User.Name"]?.Errors.Any() == true ? "is-invalid" : "")" 
                                               asp-for="User.Name" 
                                               placeholder="نام را وارد کنید">
                                        <span asp-validation-for="User.Name" class="invalid-feedback"></span>
                                    </div>

                                    <div class="mb-3">
                                        <label asp-for="User.SurName" class="form-label">
                                            <i class="ri-user-settings-line me-1"></i>
                                            نام خانوادگی
                                        </label>
                                        <input type="text" 
                                               class="form-control @(ViewData.ModelState["User.SurName"]?.Errors.Any() == true ? "is-invalid" : "")" 
                                               asp-for="User.SurName" 
                                               placeholder="نام خانوادگی را وارد کنید">
                                        <span asp-validation-for="User.SurName" class="invalid-feedback"></span>
                                    </div>

                                    <div class="mb-3">
                                        <label asp-for="User.NationalCode" class="form-label">
                                            <i class="ri-id-card-line me-1"></i>
                                            کد ملی
                                        </label>
                                        <input type="text" 
                                               class="form-control @(ViewData.ModelState["User.NationalCode"]?.Errors.Any() == true ? "is-invalid" : "")" 
                                               asp-for="User.NationalCode" 
                                               placeholder="کد ملی را وارد کنید">
                                        <span asp-validation-for="User.NationalCode" class="invalid-feedback"></span>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="ri-calendar-line me-1"></i>
                                            تاریخ تولد
                                        </label>
                                        <div class="input-group">
                                            <input type="text" 
                                                   id="DateOfBirthPicker"
                                                   class="form-control persian-datepicker @(ViewData.ModelState["User.DateOfBirth"]?.Errors.Any() == true ? "is-invalid" : "")" 
                                                   placeholder="تاریخ تولد را انتخاب کنید"
                                                   autocomplete="off"
                                                   value="@Model.User.DateOfBirth">
                                            <span class="input-group-text">
                                                <i class="ri-calendar-line"></i>
                                            </span>
                                        </div>
                                        <input type="hidden" asp-for="User.DateOfBirth" id="DateOfBirth" />
                                        <span asp-validation-for="User.DateOfBirth" class="invalid-feedback"></span>
                                        <small class="text-muted">تاریخ میلادی: <span id="gregorianDate"></span></small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <div class="col-lg-6">
                            <div class="card border">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">
                                        <i class="ri-contacts-line text-primary me-2"></i>
                                        اطلاعات تماس
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label asp-for="User.Email" class="form-label">
                                            <i class="ri-mail-line me-1"></i>
                                            ایمیل
                                        </label>
                                        <input type="email" 
                                               class="form-control @(ViewData.ModelState["User.Email"]?.Errors.Any() == true ? "is-invalid" : "")" 
                                               asp-for="User.Email" 
                                               placeholder="ایمیل را وارد کنید">
                                        <span asp-validation-for="User.Email" class="invalid-feedback"></span>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" asp-for="User.EmailConfirmed" id="emailConfirmed">
                                            <label class="form-check-label" for="emailConfirmed">
                                                <i class="ri-checkbox-circle-line me-1"></i>
                                                ایمیل تأیید شده است
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label asp-for="User.PhoneNumber" class="form-label">
                                            <i class="ri-phone-line me-1"></i>
                                            شماره تلفن
                                        </label>
                                        <input type="tel" 
                                               class="form-control @(ViewData.ModelState["User.PhoneNumber"]?.Errors.Any() == true ? "is-invalid" : "")" 
                                               asp-for="User.PhoneNumber" 
                                               placeholder="شماره تلفن را وارد کنید">
                                        <span asp-validation-for="User.PhoneNumber" class="invalid-feedback"></span>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" asp-for="User.PhoneNumberConfirmed" id="phoneConfirmed">
                                            <label class="form-check-label" for="phoneConfirmed">
                                                <i class="ri-checkbox-circle-line me-1"></i>
                                                شماره تلفن تأیید شده است
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Account Status -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card border">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">
                                        <i class="ri-shield-check-line text-primary me-2"></i>
                                        وضعیت حساب کاربری
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" asp-for="User.IsActive" id="isActive">
                                                    <label class="form-check-label" for="isActive">
                                                        <i class="ri-toggle-line me-1"></i>
                                                        حساب کاربری فعال است
                                                    </label>
                                                </div>
                                                <div class="form-text">
                                                    کاربران غیرفعال نمی‌توانند وارد سیستم شوند.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="d-flex gap-2 justify-content-end">
                                <a asp-page="Detail" asp-route-id="@Model.User.Id" class="btn btn-light">
                                    <i class="ri-arrow-right-line align-bottom me-1"></i>
                                    انصراف
                                </a>
                                <button type="submit" class="btn btn-primary" id="saveButton">
                                    <i class="ri-save-line align-bottom me-1"></i>
                                    ذخیره تغییرات
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Help Information Card -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="ri-information-line text-info me-2"></i>
                    راهنمای ویرایش کاربر
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3">نکات مهم:</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="ri-check-line text-success me-2"></i>
                                نام کاربری باید منحصر به فرد باشد
                            </li>
                            <li class="mb-2">
                                <i class="ri-check-line text-success me-2"></i>
                                ایمیل باید در فرمت صحیح وارد شود
                            </li>
                            <li class="mb-2">
                                <i class="ri-check-line text-success me-2"></i>
                                کد ملی باید ۱۰ رقم باشد
                            </li>
                            <li class="mb-2">
                                <i class="ri-check-line text-success me-2"></i>
                                تاریخ تولد باید معتبر باشد
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3">تأیید اطلاعات:</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="ri-alert-line text-warning me-2"></i>
                                تأیید ایمیل و تلفن بر دسترسی کاربر تأثیر دارد
                            </li>
                            <li class="mb-2">
                                <i class="ri-alert-line text-warning me-2"></i>
                                تغییر وضعیت فعال/غیرفعال فوری اعمال می‌شود
                            </li>
                            <li class="mb-2">
                                <i class="ri-alert-line text-warning me-2"></i>
                                تمام تغییرات در تاریخچه سیستم ثبت می‌شود
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <!-- Persian Date Picker CSS -->
    <link rel="stylesheet" href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
    

}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Form validation
            const form = document.getElementById('editForm');
            const saveButton = document.getElementById('saveButton');

            form.addEventListener('submit', function(e) {
                // Show loading state
                saveButton.innerHTML = '<i class="ri-loader-4-line align-bottom me-1"></i> در حال ذخیره...';
                saveButton.disabled = true;
            });

            // Auto-format national code
            const nationalCodeInput = document.getElementById('User_NationalCode');
            if (nationalCodeInput) {
                nationalCodeInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 10) {
                        value = value.substring(0, 10);
                    }
                    e.target.value = value;
                });
            }

            // Auto-format phone number
            const phoneInput = document.getElementById('User_PhoneNumber');
            if (phoneInput) {
                phoneInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 11) {
                        value = value.substring(0, 11);
                    }
                    e.target.value = value;
                });
            }

            // Real-time validation feedback
            const inputs = form.querySelectorAll('input[required]');
            inputs.forEach(input => {
                input.addEventListener('blur', function() {
                    if (this.value.trim() === '') {
                        this.classList.add('is-invalid');
                    } else {
                        this.classList.remove('is-invalid');
                    }
                });
            });
        });
    </script>
    
        <script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://unpkg.com/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // اطمینان از بارگذاری jQuery و persian-datepicker
            if (typeof $ === 'undefined') {
                console.error('jQuery not loaded');
                return;
            }
            
            if (typeof $.fn.persianDatepicker === 'undefined') {
                console.error('Persian Date Picker not loaded');
                return;
            }
            
            const hidden = document.getElementById('DateOfBirth');
            const visible = document.getElementById('DateOfBirthPicker');
            const gregSpan = document.getElementById('gregorianDate');
            
            if (!hidden || !visible || !gregSpan) {
                console.error('Required elements not found');
                return;
            }

            // مقدار اولیه از سرور
            const initialPersian = hidden.value;
            
            // راه‌اندازی دیت‌پیکر
            $(visible).persianDatepicker({
                format: 'YYYY/MM/DD',
                initialValue: false,  // خودمان مقدار اولیه را تنظیم می‌کنیم
                autoClose: true,
                persianDigit: false,
                onSelect: function (unix) {
                    try {
                        const p = new persianDate(unix).format('YYYY/MM/DD');
                        hidden.value = p;

                        const g = new persianDate(unix)
                                  .toCalendar('gregorian')
                                  .format('YYYY-MM-DD');
                        gregSpan.textContent = g;
                    } catch (error) {
                        console.error('Error in date picker onSelect:', error);
                    }
                }
            });

            // تنظیم مقدار اولیه با delay
            if (initialPersian) {
                // ابتدا مقدار را در input نمایشی قرار دهیم
                visible.value = initialPersian;
                
                // کمی صبر کنیم تا دیت‌پیکر کاملاً بارگذاری شود
                setTimeout(function() {
                    try {
                        // تبدیل تاریخ فارسی به timestamp
                        const parts = initialPersian.split('/');
                        if (parts.length === 3) {
                            const year = parseInt(parts[0]);
                            const month = parseInt(parts[1]);
                            const day = parseInt(parts[2]);
                            
                                                    // ایجاد تاریخ فارسی و تبدیل به timestamp
                        const persianDateObj = new persianDate([year, month, day]);
                        const timestamp = persianDateObj.valueOf();
                        
                        const pickerInstance = $(visible).data('datepicker');
                        
                        if (pickerInstance && pickerInstance.setDate) {
                            pickerInstance.setDate(timestamp);
                            
                            // نمایش تاریخ میلادی
                            const g = persianDateObj.toCalendar('gregorian').format('YYYY-MM-DD');
                            gregSpan.textContent = g;
                        }
                        }
                    } catch (error) {
                        console.error('Error setting initial date:', error);
                    }
                }, 100); // 100ms delay
            }
        });
    </script>
} 