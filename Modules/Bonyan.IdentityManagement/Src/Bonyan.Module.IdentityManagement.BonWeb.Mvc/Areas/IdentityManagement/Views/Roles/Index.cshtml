@model Bonyan.Layer.Domain.Repository.Abstractions.BonPaginatedResult<Bonyan.IdentityManagement.Application.Roles.Dtos.RoleDto>
@inject Microsoft.Extensions.Localization.IStringLocalizer<Bonyan.IdentityManagement.BonWeb.Mvc.IdentityManagementResource> L
@{
    ViewData["Title"] = L["Roles:Title"];
    Layout = "~/Views/Shared/_Layout.cshtml";
    var filter = ViewBag.Filter as Bonyan.IdentityManagement.Application.Roles.Dtos.RoleFilterDto ?? new Bonyan.IdentityManagement.Application.Roles.Dtos.RoleFilterDto();
    var results = Model?.Results ?? Enumerable.Empty<Bonyan.IdentityManagement.Application.Roles.Dtos.RoleDto>();
}
<div class="card shadow-sm border-0">
    <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2 py-3">
        <h5 class="card-title mb-0 fw-semibold">@L["Roles:Title"]</h5>
        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalCreate">
            <i class="bi bi-plus-lg me-1" aria-hidden="true"></i>@L["Roles:Create"]
        </button>
    </div>
    <div class="card-body">
        <form method="get" asp-action="Index" class="mb-3">
            <div class="row g-2">
                <div class="col-md-4">
                    <input type="text" name="Search" value="@filter.Search" class="form-control form-control-sm" placeholder="@L["Roles:SearchPlaceholder"]" />
                    <input type="hidden" name="Take" value="@filter.Take" />
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary btn-sm">@L["Roles:Search"]</button>
                </div>
            </div>
        </form>

        <div id="roles-alert-container"></div>

        @if (results.Any())
        {
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>@L["Roles:TableTitle"]</th>
                            <th>@L["Roles:TableId"]</th>
                            <th>@L["Roles:TableCanBeDeleted"]</th>
                            <th class="text-end" style="min-width: 140px;">@L["Users:Actions"]</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var role in results)
                        {
                            <tr>
                                <td class="fw-medium">@role.Title</td>
                                <td><code class="small">@role.Id?.Value</code></td>
                                <td>
                                    @if (role.CanBeDeleted)
                                    {
                                        <span class="badge bg-success">@L["Roles:Yes"]</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary" title="@L["Roles:DeleteForbidden"]">@L["Roles:No"]</span>
                                    }
                                </td>
                                <td class="text-end">
                                    <button type="button" class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal" data-bs-target="#modalEdit"
                                            data-id="@role.Id?.Value" data-title="@role.Title" data-canbedel="@role.CanBeDeleted.ToString().ToLowerInvariant()"
                                            title="@L["Roles:Edit"]">
                                        <i class="bi bi-pencil" aria-hidden="true"></i>
                                    </button>
                                    @if (role.CanBeDeleted)
                                    {
                                        <form method="post" asp-action="Delete" class="d-inline" data-role-id="@role.Id?.Value" data-role-title="@role.Title" data-confirm="@L["Roles:ConfirmDelete"]">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@role.Id?.Value" />
                                            <button type="button" class="btn btn-sm btn-outline-danger btn-delete-role" title="@L["Roles:Delete"]">
                                                <i class="bi bi-trash" aria-hidden="true"></i>
                                            </button>
                                        </form>
                                    }
                                    else
                                    {
                                        <button type="button" class="btn btn-sm btn-outline-secondary disabled" title="@L["Roles:DeleteForbidden"]" disabled>
                                            <i class="bi bi-trash" aria-hidden="true"></i>
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            @if (Model != null && Model.TotalPages > 1)
            {
                <nav class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-3 pt-3 border-top">
                    <small class="text-muted">@L["Users:Showing"] @((Model.Skip) + 1) â€“ @(Math.Min(Model.Skip + Model.Take, Model.TotalCount)) @L["Users:Of"] @Model.TotalCount</small>
                    <ul class="pagination pagination-sm mb-0">
                        @if (Model.Page > 1)
                        {
                            <li class="page-item">
                                <a class="page-link" href="?Search=@filter.Search&Skip=@(Model.Skip - Model.Take)&Take=@Model.Take">@L["Users:Previous"]</a>
                            </li>
                        }
                        @for (var p = Math.Max(1, Model.Page - 2); p <= Math.Min(Model.TotalPages, Model.Page + 2); p++)
                        {
                            var skip = (p - 1) * Model.Take;
                            <li class="page-item @(p == Model.Page ? "active" : "")">
                                <a class="page-link" href="?Search=@filter.Search&Skip=@skip&Take=@Model.Take">@p</a>
                            </li>
                        }
                        @if (Model.Page < Model.TotalPages)
                        {
                            <li class="page-item">
                                <a class="page-link" href="?Search=@filter.Search&Skip=@(Model.Skip + Model.Take)&Take=@Model.Take">@L["Users:Next"]</a>
                            </li>
                        }
                    </ul>
                </nav>
            }
        }
        else
        {
            <p class="text-muted mb-0 py-4 text-center">@L["Roles:NoRolesFound"]</p>
        }
    </div>
</div>

<!-- Create modal -->
<div class="modal fade" id="modalCreate" tabindex="-1" aria-labelledby="modalCreateLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-action="Create" id="formCreate">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title" id="modalCreateLabel">@L["Roles:Create"]</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="@L["Common:Close"]"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label" for="createId">@L["Roles:TableId"]</label>
                        <input type="text" name="Id" id="createId" class="form-control" required placeholder="@L["Roles:IdPlaceholder"]" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="createTitle">@L["Roles:TableTitle"]</label>
                        <input type="text" name="Title" id="createTitle" class="form-control" required />
                    </div>
                    <div class="form-check">
                        <input type="hidden" name="CanBeDeleted" value="false" />
                        <input type="checkbox" name="CanBeDeleted" value="true" id="createCanBeDeleted" class="form-check-input" checked />
                        <label class="form-check-label" for="createCanBeDeleted">@L["Roles:TableCanBeDeleted"]</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@L["Roles:Cancel"]</button>
                    <button type="submit" class="btn btn-primary">@L["Roles:Create"]</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit modal -->
<div class="modal fade" id="modalEdit" tabindex="-1" aria-labelledby="modalEditLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-action="Update" id="formEdit">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" id="editId" />
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditLabel">@L["Roles:Edit"]</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="@L["Common:Close"]"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label" for="editTitle">@L["Roles:TableTitle"]</label>
                        <input type="text" name="Title" id="editTitle" class="form-control" required />
                    </div>
                    <div class="form-check">
                        <input type="hidden" name="CanBeDeleted" value="false" />
                        <input type="checkbox" name="CanBeDeleted" value="true" id="editCanBeDeleted" class="form-check-input" />
                        <label class="form-check-label" for="editCanBeDeleted">@L["Roles:TableCanBeDeleted"]</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@L["Roles:Cancel"]</button>
                    <button type="submit" class="btn btn-primary">@L["Roles:Save"]</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script>
(function() {
    var successMsg = @(TempData["Success"] != null ? Json.Serialize(TempData["Success"].ToString()) : "null");
    var errorMsg = @(TempData["Error"] != null ? Json.Serialize(TempData["Error"].ToString()) : "null");

    function showToast(message, isError) {
        if (typeof Swal === 'undefined') {
            var div = document.getElementById('roles-alert-container');
            if (div) {
                div.innerHTML = '<div class="alert alert-' + (isError ? 'danger' : 'success') + ' alert-dismissible fade show">' + message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
            }
            return;
        }
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: isError ? 'error' : 'success',
            title: message,
            showConfirmButton: false,
            timer: 4000,
            timerProgressBar: true
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (successMsg) showToast(successMsg, false);
        if (errorMsg) showToast(errorMsg, true);
    });

    var modalEdit = document.getElementById('modalEdit');
    if (modalEdit) {
        modalEdit.addEventListener('show.bs.modal', function(e) {
            var btn = e.relatedTarget;
            if (btn) {
                document.getElementById('editId').value = btn.getAttribute('data-id') || '';
                document.getElementById('editTitle').value = btn.getAttribute('data-title') || '';
                document.getElementById('editCanBeDeleted').checked = btn.getAttribute('data-canbedel') === 'true';
            }
        });
    }

    document.querySelectorAll('.btn-delete-role').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var form = this.closest('form');
            var title = form.getAttribute('data-role-title') || '';
            var confirmKey = form.getAttribute('data-confirm') || 'Delete this role?';
            var msg = confirmKey.indexOf('{0}') !== -1 ? confirmKey.replace('{0}', title) : confirmKey;
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    title: msg,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    confirmButtonText: '@L["Roles:Delete"]',
                    cancelButtonText: '@L["Roles:Cancel"]'
                }).then(function(r) {
                    if (r.isConfirmed) form.submit();
                });
            } else if (confirm(msg)) {
                form.submit();
            }
        });
    });
})();
</script>
}
